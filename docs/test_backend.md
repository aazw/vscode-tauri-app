# Backend Test Documentation

このドキュメントでは、Tauriアプリケーションのバックエンドテスト構造について説明します。

## テスト構造

### 統合テスト (`src-tauri/tests/`)

正式なテスト構造として、以下の3つのテストファイルを配置しています：

#### 1. `database_tests.rs` - 包括的なデータベース機能テスト

**概要**: データベースの全機能を網羅的にテストする包括的なテストスイート

**主要テスト項目**:
- **データベース作成テスト**
  - 新規データベースファイルの作成
  - 既存データベースファイルの読み込み
  - 破損したファイルの処理
  - デフォルトプロバイダーの初期化

- **プロバイダーCRUDテスト**
  - プロバイダーの追加・取得・更新・削除
  - プロバイダー一覧の取得（時間順ソート）
  - トークンの更新
  - カスケード削除（プロバイダー削除時の関連データ削除）

- **リポジトリCRUDテスト**
  - リポジトリの追加・取得・削除
  - プロバイダー別リポジトリ取得
  - カスケード削除（リポジトリ削除時のイシュー・PR・ワークフロー削除）

- **イシューテスト**
  - フィルタリング（状態、担当者、検索）
  - ページネーション（境界値テスト含む）
  - 統計情報の取得
  - 大小文字を区別しない検索

- **プルリクエストテスト**
  - 状態フィルタリング（open/merged/closed）
  - 統計情報の取得

- **ワークフローテスト**
  - ワークフローラン（`workflow_runs`テーブル）の取得
  - ステータスフィルタリング（success/failure/in_progress/cancelled）
  - 統計情報の取得

- **エラーハンドリング・境界値テスト**
  - ゼロ値のページネーション
  - 空文字列フィルター
  - 大きなページネーション値
  - 存在しないレコードのエラーハンドリング
  - 同時アクセステスト

#### 2. `migration_tests.rs` - マイグレーション処理のテスト

**概要**: データベースマイグレーション機能の正確性と安全性をテスト

**主要テスト項目**:
- **マイグレーション適用テスト**
  - マイグレーションの正常実行
  - 適用されたマイグレーション数の検証

- **スキーマ検証テスト**
  - 必要なテーブルの存在確認（`git_providers`, `repositories`, `issues`, `pull_requests`, `workflow_runs`, `sync_history`等）
  - テーブル構造の検証
  - インデックスの確認

- **ロールバック・再適用テスト**
  - 重複マイグレーションの防止
  - べき等性の保証

- **デフォルトデータシード**
  - デフォルトプロバイダー（GitHub.com/GitLab.com）の作成確認（ID: 1, 2）
  - プロバイダー数の検証（最低2つ）
  - シードデータの整合性検証

#### 3. `integration_tests.rs` - 統合テストとエラーハンドリング

**概要**: アプリケーション全体の統合テストとエラー処理のテスト

**主要テスト項目**:
- **基本機能統合テスト**
  - データベース初期化からプロバイダー取得までの一連の流れ
  - デフォルトプロバイダーの確認
  - 空リポジトリリストの確認

- **マルチインスタンステスト**
  - 同一データベースファイルへの複数インスタンスアクセス
  - データ整合性の確認

- **ファイルシステムテスト**
  - データベースファイルの権限・サイズ確認
  - ファイル存在確認

- **並行アクセステスト**
  - 複数スレッドからの同時データベースアクセス
  - データ競合の防止確認

- **エラーハンドリングテスト**
  - 無効なパスでのデータベース作成
  - 適切なエラーメッセージの確認
  - パニックの防止

## テスト実行方法

```bash
# 全テストの実行
cargo test

# 特定のテストファイルのみ実行
cargo test --test database_tests
cargo test --test migration_tests
cargo test --test integration_tests

# 詳細ログ付きでテスト実行
cargo test -- --nocapture
```

## テスト統計

現在のテスト数：**31個**
- `database_tests.rs`: 22個のテスト
- `integration_tests.rs`: 5個のテスト  
- `migration_tests.rs`: 4個のテスト

## テスト環境

- **一時ファイル**: `tempfile`クレートを使用してテスト用の一時データベースを作成
- **並行実行**: テストは並行実行可能（各テストが独立した一時データベースを使用）
- **クリーンアップ**: テスト終了時に一時ファイルは自動削除

## 従来のテスト構造からの移行

以下の一時的なテストファイルは削除され、正式なテスト構造に移行されました：

- `test_implementation.md` → ドキュメント化
- `test_migration.rs` → `tests/migration_tests.rs`
- `src-tauri/Cargo_test.toml` → 削除（不要）
- `src-tauri/src/database_tests.rs` → `tests/database_tests.rs`
- `src-tauri/src/migration_test.rs` → `tests/migration_tests.rs`
- `src-tauri/src/minimal_test.rs` → `tests/integration_tests.rs`
- `src-tauri/src/simple_test.rs` → 削除（重複）
- `src-tauri/src/test_runner.rs` → 削除（不要）

## カバレッジ

現在のテストスイートは以下をカバーしています：

- ✅ データベース初期化・マイグレーション
- ✅ 全CRUDオペレーション
- ✅ フィルタリング・ページネーション
- ✅ 統計情報の計算
- ✅ エラーハンドリング
- ✅ 並行アクセス
- ✅ 境界値テスト
- ✅ データ整合性

テストスイートは継続的に拡張され、新機能の追加時には対応するテストも追加されます。